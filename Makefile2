# ====== Environment ======
VENV ?= .venv
PYTHON := $(VENV)/bin/python
PIP := $(VENV)/bin/pip

setup:
	@test -d $(VENV) || python3 -m venv $(VENV)
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt matplotlib jupyter nbformat nbconvert

# ====== Simulation / Plotting ======
simulate:
	@echo "==> Simulating with config: batsim/$(CONFIG).json"
	@bash batsim/run_replay.sh batsim/$(CONFIG).json

simulate-LLNL:
	@$(MAKE) CONFIG=config_llnl simulate

simulate-KTH:
	@$(MAKE) CONFIG=config_kth simulate

plot:
	$(VENV)/bin/jupyter nbconvert --to html --execute --ExecutePreprocessor.timeout=240 notebooks/plot_backlog_energy_co2e.ipynb --output notebooks/plot_report.html
	@echo "Rendered notebooks/plot_report.html"

# ====== Data → Features → Surrogates ======
features:
	python scripts/build_features.py --jobs_csv data/processed/llnl_jobs.csv --synthetic-energy

train-runtime:
	python scripts/train_runtime_surrogate.py --csv data/processed/runtime_features.csv --target runtime_s

train-energy:
	python scripts/train_energy_surrogate.py --csv data/processed/energy_features.csv --target energy_j

train: features train-runtime train-energy
	@echo "All surrogates trained."

# ====== RL training ======
rl-train:
	$(PYTHON) -m rl.train_ppo --jobs data/processed/llnl_jobs.csv --timesteps 20000

rl-train-fast:
	$(PYTHON) -m rl.train_ppo --jobs data/processed/llnl_jobs.csv --timesteps 5000

# ====== Housekeeping ======
clean:
	@rm -rf notebooks/*.html batsim/results_* .ipynb_checkpoints

.PHONY: setup simulate simulate-LLNL simulate-KTH plot features train-runtime train-energy train rl-train rl-train-fast clean
